From: Claude AI Assistant
Subject: [PATCH] Update command handler to pass commandId to port allocation methods

This patch updates the command handler to pass the commandId to the port allocation
service methods, enabling proper acknowledgment tracking.

---
 src/DeCloud.NodeAgent/Services/CommandHandlerService.cs | 20 ++++++++++----------
 1 file changed, 10 insertions(+), 10 deletions(-)

diff --git a/src/DeCloud.NodeAgent/Services/CommandHandlerService.cs b/src/DeCloud.NodeAgent/Services/CommandHandlerService.cs
index 1234567..abcdefg 100644
--- a/src/DeCloud.NodeAgent/Services/CommandHandlerService.cs
+++ b/src/DeCloud.NodeAgent/Services/CommandHandlerService.cs
@@ -50,7 +50,7 @@ public class CommandHandlerService
                     await HandleStopVmCommandAsync(command);
                     break;
                 case "AllocatePort":
-                    await HandleAllocatePortCommandAsync(command);
+                    await HandleAllocatePortCommandAsync(command.CommandId, command);
                     break;
                 case "RemovePort":
-                    await HandleRemovePortCommandAsync(command);
+                    await HandleRemovePortCommandAsync(command.CommandId, command);
                     break;
                 default:
                     _logger.LogWarning("Unknown command type: {Type}", command.Type);
@@ -65,7 +65,7 @@ public class CommandHandlerService
     /// <summary>
     /// Handle AllocatePort command
     /// </summary>
-    private async Task HandleAllocatePortCommandAsync(NodeCommand command)
+    private async Task HandleAllocatePortCommandAsync(string commandId, NodeCommand command)
     {
         try
         {
             var payload = JsonSerializer.Deserialize<AllocatePortPayload>(command.Payload);
             if (payload == null)
             {
                 _logger.LogError("Failed to deserialize AllocatePort payload");
                 return;
             }

             _logger.LogInformation(
                 "Processing AllocatePort command {CommandId} for VM {VmId}",
-                command.CommandId, payload.VmId);
+                commandId, payload.VmId);

             var success = await _portAllocationService.HandleAllocatePortCommandAsync(
+                commandId,
                 payload.VmId,
                 payload.VmPrivateIp,
                 payload.VmPort,
                 payload.Protocol,
                 payload.Label);

             if (success)
             {
                 _logger.LogInformation(
                     "✓ AllocatePort command {CommandId} completed successfully",
-                    command.CommandId);
+                    commandId);
             }
             else
             {
                 _logger.LogError(
                     "✗ AllocatePort command {CommandId} failed",
-                    command.CommandId);
+                    commandId);
             }
         }
         catch (Exception ex)
         {
             _logger.LogError(ex,
                 "Error processing AllocatePort command {CommandId}",
-                command.CommandId);
+                commandId);
         }
     }

     /// <summary>
     /// Handle RemovePort command
     /// </summary>
-    private async Task HandleRemovePortCommandAsync(NodeCommand command)
+    private async Task HandleRemovePortCommandAsync(string commandId, NodeCommand command)
     {
         try
         {
             var payload = JsonSerializer.Deserialize<RemovePortPayload>(command.Payload);
             if (payload == null)
             {
                 _logger.LogError("Failed to deserialize RemovePort payload");
                 return;
             }

             _logger.LogInformation(
                 "Processing RemovePort command {CommandId} for VM {VmId}",
-                command.CommandId, payload.VmId);
+                commandId, payload.VmId);

             var success = await _portAllocationService.HandleRemovePortCommandAsync(
+                commandId,
                 payload.VmId,
                 payload.VmPort,
                 payload.Protocol);

             if (success)
             {
                 _logger.LogInformation(
                     "✓ RemovePort command {CommandId} completed successfully",
-                    command.CommandId);
+                    commandId);
             }
             else
             {
                 _logger.LogError(
                     "✗ RemovePort command {CommandId} failed",
-                    command.CommandId);
+                    commandId);
             }
         }
         catch (Exception ex)
         {
             _logger.LogError(ex,
                 "Error processing RemovePort command {CommandId}",
-                command.CommandId);
+                commandId);
         }
     }
 }

